---
title: "4-northeast-analysis"
author: "Daniel Hocking"
date: "August 28, 2014"
output: html_document
---

```{r results = 'hide', }
#rm(list=ls())

library(knitr)
#basename <- gsub(".Rmd", "", knitr:::knit_concord$get("infile"))
#opts_chunk$set(fig.path = paste("figure/", basename, "-", sep = ""), cache.path = paste("cache/", basename, "/", sep = ""))
#basename <- "testName"
#opts_chunk$set(cache.path = paste("cache/", basename, "/", sep = ""))
#opts_chunk$set(cache = 1)
opts_chunk$set(tidy = FALSE, warning = FALSE, message = FALSE, comment = NA, verbose = TRUE)

```


```{r results = 'hide', warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(nlme)
library(devtools)
#install_github("conteStreamTemperature", username = "Conte-Ecology")
library(conteStreamTemperature)

#setwd('/Users/Dan/Documents/Research/Stream_Climate_Change/temperatureProject/')
#setwd('C:/Users/dhocking/Documents/temperatureProject/')

#baseDir <- 'C:/KPONEIL/GitHub/projects/temperatureProject/'
#baseDir <- "/Users/Dan/Documents/Research/Stream_Climate_Change/conteStreamTemperature_northeast"
baseDir <- getwd() # works as long as you have the project loaded in RStudio - does not work for kniting

dataInDir <- paste0(baseDir, '/dataIn/')
dataOutDir <- paste0(baseDir, '/dataOut/')
dataLocalDir <- paste0(baseDir, '/localData/')
graphsDir <- paste0(baseDir, '/graphs/')

#source(paste0(baseDir, 'code/functions/temperatureModelingFunctions.R'))

# load standardized and formatted data created with the 3-statModelPrep.Rmd script
load(paste0(dataOutDir, 'tempDataSync.RData'))
```

```{r eval = FALSE}
print(getwd())
```


```{r run-model, results = 'hide'}
########## JAGS Model ##############
coda.tf <- T # currently only works in full for TRUE (using coda.samples)
M3 <- modelRegionalTemp(tempDataSyncS, n.burn = 300, n.it = 1000, n.thin = 3, n.chains = 3, coda = coda.tf)

save(M3, file = paste0(dataLocalDir, "northeast-mcmc.RData"))
```

### Check model convergence
```{r convergence}
if(coda.tf) {
  pdf("/Users/Dan/Dropbox/correlatedSlopes.pdf")
  #pdf("C:/Users/dhocking/Dropbox/correlatedSlopes.pdf")
  plot(M3[ , 1:200])
  dev.off()
  
  pairs(as.matrix(M3[ , c(1:8, 17:20)]))
  
  mcmc.cor <- cor(as.matrix(M3))
  quantile(mcmc.cor, na.rm = TRUE, probs = c(0.5, 0.9, 0.99, 0.999. 0.9999))
  
  gelman.diag(M3[ , 1:99])
} else {
  ## deviance
#[1, 1:200, 3]
library(reshape2)
temp2 <- melt(((M3$deviance[,,])))
temp2 <- melt(((M3$sigma[,,])))
ggplot(temp2, aes(Var1,(value), colour=factor(Var2) )) +  
    geom_point(size=1) +
    scale_x_continuous('Iteration') +
    scale_y_continuous('Deviance') +
    ggtitle('desc')

## B.0
#[1:2, 1:200, 3]

temp2 <- melt(((M3$B.0[,,])))
temp2 <- melt(((M3$mu.year[,,])))
temp2 <- melt(((M3$mu.site[,,])))
temp2 <- melt(((M3$sigma.b.year[,,])))
temp2 <- melt(((M3$B.year[,,])))


ggplot(temp2, aes(Var2,(value), colour=factor(Var3) )) +  
    geom_point(size=1) +
    scale_x_continuous('Iteration') +
    scale_y_continuous('Deviance') +
    stat_smooth()+
    facet_grid(~Var1)


## B.Site
#[1:4, 1:4, 1:200, 3]

temp2 <- melt(((M3$B.site[,,,])))

ggplot(temp2[temp2$Var2==1,], aes(Var3,(value), colour=factor(Var4) )) +  
    geom_point(size=.25) +
    scale_x_continuous('Iteration') +
    scale_y_continuous('Deviance') +
    stat_smooth()+
    facet_wrap(Var2~Var1)
}

```


###### Consider: Slope, Aspect, Dams/Impoundments, Agriculture, Wetland, Coarseness, dayl, srad, swe

###### Add correlation structure for Lat-Lon and/or HUC ########

##### Add autoregressive component to the model? #########

##### Add interactions such as airTemp*drainage






